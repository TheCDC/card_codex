{% extends "layout.html" %}
{% block head %}
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='vendor/awesomplete/awesomplete.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='home.css') }}">
{% endblock %}
{% block body %}
<div class="title-box">
  <h1 class="heading">Card Codex</h1>
  <p class="subtitle">M:tG card similarity search</p>
</div>
<div id="search" class="search-bar">
  <ul class="tab">
    <li class="tablinks active" onclick="openTab(event, 'search-by-card')">Search by card</li>
    <li class="tablinks" onclick="openTab(event, 'search-by-text')">Search by text</li>
  </ul>
  <div id="search-by-card" class="tabcontent active">
    <form action="/" method="get">
      <div>
        <label><input id="card-search" name="card" type="text" placeholder="Enter a card name"></label>
        <button type="submit">Search</button>
        <a href="/random"><button type="button">Random card</button></a>
      </div>
    </form>
  </div>
  <div id="search-by-text" class="tabcontent">
    <form action="/" method="get">
      <div>
        <label><input id="text-search" name="text" type="text" placeholder="Enter some card text"></label>
        <button type="submit">Search</button>
      </div>
    </form>
  </div>
  {% if error %}
  <div class="error"><span>{{error}}</span></div>
  {% endif %}
</div>
{% if target_card %}
<div class="card-detail">
  <h2><a href="http://magiccards.info/query?q={{target_card.name | urlencode}}">{{target_card.name}}</a></h2>
  <p>{{target_card.manaCost | mana}} &middot; {{target_card.type}}</p>
  <p class="card-text">{{target_card.text}}</p>
  {% if target_card.names | length > 1 %}
  <p>Other side:
    {% for name in target_card.names if name != target_card.name %}
    <a href="/?card={{name | urlencode}}#search">{{name}}</a>
    {% endfor %}
  </p>
  {% endif %}
</div>

{% endif %}
{% if similar_cards %}
<div class="search-results">
  <h2 class="heading">Similar cards</h2>
  <div class="pull-right">
    <form name="filters" class="filters">
      <input type="hidden" name="card" value="{{target_card.name}}">
      <div>
        Color identity:
        {% macro has_filter(attr, val) -%}
          {{'checked' if filters and val in filters[attr] else ''-}}
        {% endmacro -%}
        {% macro filter_checkbox(attr, val) -%}
        <label>{{val}} <input type="checkbox" name="{{attr}}" value="{{val}}" {{has_filter(attr, val)}}></label>
        {% endmacro -%}
        {% for color in 'WUBRG' -%}
        {{ filter_checkbox('ci', color) -}}
        {% endfor %}
        <button type="submit" style="margin-left: 8px; margin-right: 16px;">Filter</button>
      </div>
      {% if page > 1 %}<input type="hidden" name="page" value={{page}}>{% endif %}
    </form>
  </div>
  <table>
    <thead><tr>
      <th>Name</th><th>Mana</th><th>Type</th><th>Text</th>
    </tr></thead>
    <tbody>
    {% for card in similar_cards %}
      <tr>
        <td><a href="/?card={{card.name | urlencode}}#search">{{card.name}}</a></td>
        <td>{{card.manaCost | mana}}</td><td>{{card.type}}</td>
        <td>{{card.text}}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<div class="pager">
  {% if page > 1 %}
    {% if page > 2 %}
    <a href="/?card={{target_card.name | urlencode}}{{filters | params}}"><button>&lt;&lt;</button></a>
    {% endif %}
    <a href="/?card={{target_card.name | urlencode}}{{filters | params}}&page={{page-1}}"><button>&lt;</button></a>
  {% endif %}
  Page {{page}}
  <a href="/?card={{target_card.name | urlencode}}{{filters | params}}&page={{page+1}}"><button>&gt;</button></a>
</div>
{% endif %}
{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename='vendor/awesomplete/awesomplete.min.js') }}"></script>
<script>
function toPage(e){
  console.log('whoa', e, this)
  return false
}

function openTab(evt, contentId) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    //tabcontent[i].style.display = "none";
    tabcontent[i].className = tabcontent[i].className.replace(" active", "");
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  //document.getElementById(contentId).style.display = "block";
  document.getElementById(contentId).className += " active";
  evt.currentTarget.className += " active";
}

(function() {
  var httpRequest;
  makeRequest('GET', '/static/card_commander_cardlist.txt');

  function successCallback(text){
    var input = document.getElementById('card-search');
    new Awesomplete(input, {
      minChars: 3,
      maxItems: 10,
      list: text.split('\n')
    });
  }

  function errorCallback(xhr){
    console.error(xhr);
  }

  function makeRequest(method, url) {
    httpRequest = new XMLHttpRequest();

    if (!httpRequest) {
      console.warn('Giving up :( Cannot create an XMLHTTP instance');
      return false;
    }
    httpRequest.onreadystatechange = alertContents;
    httpRequest.open(method, url);
    httpRequest.send();
  }

  function alertContents() {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        successCallback(httpRequest.responseText);
      } else {
        errorCallback(httpRequest);
      }
    }
  }
})();
</script>
{% endblock %}
